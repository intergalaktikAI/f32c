name: Build sdram_min Bitstream

on:
  workflow_dispatch:
    inputs:
      device:
        description: 'ECP5 Device Size'
        required: true
        default: '12'
        type: choice
        options:
          - '12'
          - '25'
          - '45'
          - '85'

env:
  DEVICE: ${{ github.event.inputs.device || '12' }}
  PROJECT_DIR: rtl/proj/lattice/ulx3s/sdram_min_trellis_v2

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Run synthesis (GHDL + Yosys)
      run: |
        docker run --rm -v ${{ github.workspace }}/rtl:/src \
          -w /src/proj/lattice/ulx3s/sdram_min_trellis_v2 \
          hdlc/ghdl:yosys \
          yosys -m ghdl synth_docker.ys

    - name: Install nextpnr-ecp5
      run: |
        wget -q https://github.com/YosysHQ/oss-cad-suite-build/releases/download/2024-12-09/oss-cad-suite-linux-x64-20241209.tgz
        tar xzf oss-cad-suite-linux-x64-20241209.tgz
        echo "$PWD/oss-cad-suite/bin" >> $GITHUB_PATH

    - name: Run place and route (nextpnr-ecp5)
      working-directory: ${{ env.PROJECT_DIR }}
      run: |
        nextpnr-ecp5 --${{ env.DEVICE }}k --speed 6 --package CABGA381 \
          --json sdram_min.json \
          --lpf ulx3s_nextpnr.lpf \
          --lpf-allow-unconstrained \
          --timing-allow-fail \
          --textcfg sdram_min.config

    - name: Generate bitstream (ecppack)
      working-directory: ${{ env.PROJECT_DIR }}
      run: |
        ecppack --compress sdram_min.config sdram_min.bit

    - name: Upload bitstream artifact
      uses: actions/upload-artifact@v4
      with:
        name: sdram_min-${{ env.DEVICE }}k
        path: ${{ env.PROJECT_DIR }}/sdram_min.bit
